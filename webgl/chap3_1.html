<html>
<head>
    <script src="./lib/three.js"></script>
    <script src="./lib/sim/sim.js"></script>
    <script>
        
        Earth.prototype.init = function () {
            var earthGroup = new THREE.Object3D();
            this.setObject3D(earthGroup);
        }
        ///////////

        ROTATION_Y = 0.001;
        TILE = 0.41;
        CLOUDS_SCALE = 1.005;
        CLOUDS_ROTATION_Y = ROTATION_Y * 0.95;

        var renderer = null,
                scene = null,
                camera = null,
                cube = null,
                animating = false;
        function onLoad () {
            var container = document.getElementById("container");
            var renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            container.appendChild(renderer.domElement);

            // SCENE
            var scene = new THREE.Scene();

            var camera = new THREE.PerspectiveCamera(45, container.offsetWidth / container.offsetHeight, 1, 4000);
            camera.position.set(0, 0, 3);
            scene.add(camera);

            // light
            var light = new THREE.PointLight(0xffffff, 2, 100);
            light.position.set(-10, 0, 20);
            scene.add(light);

            var mapUrl = "./res/earth_surface_2048.jpg";
            var surfaceMap = THREE.ImageUtils.loadTexture("./res/earth_surface_2048.jpg");
            var normalMap = THREE.ImageUtils.loadTexture("./res/earth_normal_2048.jpg");
            var specularMap = THREE.ImageUtils.loadTexture("./res/earth_specular_2048.jpg");

            var shader = THREE.ShaderUtils.lib[ "normal" ];
            var uniforms = THREE.UniformsUtils.clone(shader.uniforms);


            uniforms["tNormal"].texture = normalMap;
            uniforms["tDiffuse"].texture = surfaceMap;
            uniforms["tSpecular"].texture = specularMap;

            uniforms["enableDiffuse"].value = true;
            uniforms["enableSpecular"].value = true;

            var shaderMaterial = new THREE.ShaderMaterial({
                fragmentShader: shader.fragmentShader,
                vertexShader: shader.vertexShader,
                uniforms: uniforms,
                lights: true
            });

            var globeGeometry = new THREE.SphereGeometry(1, 32, 32);

            globeGeometry.computeTangents();
            var globeMesh = new THREE.Mesh(globeGeometry, shaderMaterial);
            globeMesh.rotation.z = TILE;
            scene.add(globeMesh);

            var cloudsMap = THREE.ImageUtils.loadTexture("./res/earth_clouds_1024.png");
            var cloudsMaterial = new THREE.MeshLambertMaterial({
                color: 0xffffff, map: cloudsMap, transparent: true
            });
            var cloudsGeometry = new THREE.SphereGeometry(CLOUDS_SCALE, 32, 32),
                cloudsMesh = new THREE.Mesh(cloudsGeometry, cloudsMaterial);
            cloudsMesh.rotation.z = TILE;
            scene.add(cloudsMesh);

            var map = THREE.ImageUtils.loadTexture(mapUrl);

            var material = new THREE.MeshPhongMaterial({map: map});
            // var material = new THREE.MeshBasicMaterial({map: map});
            var geometry = new THREE.SphereGeometry(1, 32, 32);

//            var geometry2 = new THREE.SphereBufferGeometry(1, 64, 16);
//            var wireframe = new THREE.WireframeGeometry(geometry2);
//            var line = new THREE.LineSegments(geometry2);
//            line.material.depthTest = false;
//            line.material.opacity = 0.25;
//            line.material.transparent = true;
            var cube = new THREE.Mesh(geometry, material);

            cube.rotation.x = Math.PI / 5;
            cube.rotation.y = Math.PI / 5;

            scene.add(cube);
            // scene.add(line);

            addMouseHandler();

            run();

            function run () {
                renderer.render(scene, camera);

                if (animating) {
                    globeMesh.rotation.y -= 0.01;
                    cloudsMesh.rotation.y -= 0.01;
                }
                requestAnimationFrame(run);
            }

            function addMouseHandler () {
                var dom = renderer.domElement;
                dom.addEventListener('mouseup', onMouseUp, false);
            }

            function onMouseUp (event) {
                event.preventDefault();
                animating = !animating;
            }

        }
    </script>
</head>
<body onLoad="onLoad();">
<div id="container" style="width: 500px;height: 500px; background-color: #000"></div>
</body>
</html>